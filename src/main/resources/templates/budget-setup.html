<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetWise | Set Budgets</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
<div class="dashboard-container">
    <!-- Sidebar (Same as budgets.html) -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo"><i class="fas fa-chart-line"></i><h2>Budget<span>Wise</span></h2></div>
        </div>
        <div class="user-profile">
            <div class="avatar"><i class="fas fa-user-circle"></i></div>
            <div class="user-info">
                <h4 th:text="${userName}">User Name</h4>
                <p>Set Budgets</p>
            </div>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="/dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                <li><a href="/expenses"><i class="fas fa-wallet"></i><span>Expenses</span></a></li>
                <li class="active"><a href="/budgets"><i class="fas fa-chart-pie"></i><span>Budget</span><span class="badge">AI</span></a></li>
                <li><a href="/budgets/budget-and-goals"><i class="fas fa-bullseye"></i><span>Saving Goals</span></a></li>
                <li><a href="#"><i class="fas fa-robot"></i><span>AI Advisor</span></a></li>
                <li><a href="#"><i class="fas fa-bell"></i><span>Alerts</span></a></li>
                <li><a href="#"><i class="fas fa-chart-bar"></i><span>Reports</span></a></li>
                <li><a href="#"><i class="fas fa-cog"></i><span>Settings</span></a></li>
            </ul>
        </nav>
        <div class="sidebar-footer">
            <a href="/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
        </div>
    </aside>

    <main class="main-content">
        <header class="main-header">
            <div class="header-left">
                <h1>Set Monthly Budgets</h1>
                <p>Plan your spending for better financial control</p>
            </div>
            <div class="header-right">
                <a href="/budgets" class="btn-secondary">
                    <i class="fas fa-arrow-left"></i> Back to Dashboard
                </a>
            </div>
        </header>

        <!-- Success/Error Messages -->
        <div th:if="${success}" class="alert alert-success">
            <i class="fas fa-check-circle"></i>
            <span th:text="${success}"></span>
        </div>
        <div th:if="${error}" class="alert alert-error">
            <i class="fas fa-exclamation-circle"></i>
            <span th:text="${error}"></span>
        </div>

        <!-- Budget Setup Form -->
        <div class="content-card">
            <div class="card-header">
                <h3><i class="fas fa-edit"></i> Set Budget Limits</h3>
                <p>Enter monthly spending limits for each category</p>
            </div>

            <form id="budgetForm" action="/budgets/save" method="POST">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="form-group">
                    <label for="category">Category</label>
                    <select id="category" name="category" required>
                        <option value="">Select a category</option>
                        <option th:each="cat : ${commonCategories}"
                                th:value="${cat}"
                                th:text="${cat}">Category</option>
                        <option value="Custom">Custom Category</option>
                    </select>
                </div>

                <div class="form-group" id="customCategoryGroup" style="display: none;">
                    <label for="customCategory">Custom Category Name</label>
                    <input type="text" id="customCategory" name="customCategory"
                           placeholder="Enter custom category name">
                </div>

                <div class="form-group">
                    <label for="amount">Monthly Budget Limit (₹)</label>
                    <input type="number" id="amount" name="amount"
                           step="100" min="0" placeholder="e.g., 5000" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-save"></i> Save Budget
                    </button>
                    <button type="button" class="btn-secondary" onclick="resetForm()">
                        <i class="fas fa-redo"></i> Reset
                    </button>
                </div>
            </form>
        </div>

        <!-- Existing Budgets -->
        <div th:if="${hasExistingBudgets}" class="content-card">
            <div class="card-header">
                <h3><i class="fas fa-list"></i> Your Current Budgets</h3>
            </div>

            <div class="table-container">
                <table class="transactions-table">
                    <thead>
                    <tr>
                        <th>Category</th>
                        <th>Monthly Limit</th>
                        <th>Spent</th>
                        <th>Remaining</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="budget : ${existingBudgets}">
                        <td th:text="${budget.category}">Category</td>
                        <td>₹<span th:text="${#numbers.formatDecimal(budget.monthlyLimit, 1, 2)}">0.00</span></td>
                        <td>₹<span th:text="${#numbers.formatDecimal(budget.spentAmount, 1, 2)}">0.00</span></td>
                        <td>₹<span th:text="${#numbers.formatDecimal(budget.remainingAmount, 1, 2)}">0.00</span></td>
                        <td>
                               <span class="badge"
                                     th:class="${budget.status == 'ON_TRACK'} ? 'success' :
                 (${budget.status == 'WARNING'} ? 'warning' : 'error')"
                                     th:text="${budget.status}">Status</span>
                        </td>
                        <td>
                            <a th:href="@{/budgets/delete/{id}(id=${budget.budgetId})}"
                               class="table-action"
                               title="Delete"
                               onclick="return confirm('Delete this budget?')">
                                <i class="fas fa-trash"></i>
                            </a>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- AI Quick Setup -->
        <div class="content-card">
            <div class="card-header">
                <h3><i class="fas fa-robot"></i> AI Quick Setup</h3>
                <p>Let AI create budgets based on your income</p>
            </div>

            <form action="/budgets/quick-setup" method="POST">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="form-group">
                    <label for="aiMonthlyIncome">Your Monthly Income (₹)</label>
                    <input type="number" id="aiMonthlyIncome" name="monthlyIncome"
                           step="1000" min="1000" placeholder="e.g., 50000" required>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-ai">
                        <i class="fas fa-robot"></i> Generate AI Budgets
                    </button>
                </div>
            </form>

            <div style="margin-top: 1.5rem; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <h4 style="margin-bottom: 0.5rem;"><i class="fas fa-lightbulb"></i> How AI Budgeting Works:</h4>
                <ul style="margin: 0; padding-left: 1.5rem; color: #666;">
                    <li>Uses the 50/30/20 rule: 50% Needs, 30% Wants, 20% Savings</li>
                    <li>Automatically allocates amounts to common categories</li>
                    <li>Creates balanced budgets based on your income</li>
                    <li>You can adjust the amounts later</li>
                </ul>
            </div>
        </div>
    </main>
</div>

<script>
    // Show/hide custom category field
    document.getElementById('category').addEventListener('change', function() {
        const customGroup = document.getElementById('customCategoryGroup');
        if (this.value === 'Custom') {
            customGroup.style.display = 'block';
        } else {
            customGroup.style.display = 'none';
        }
    });

    // Handle form submission for custom categories
    document.getElementById('budgetForm').addEventListener('submit', function(e) {
        const categorySelect = document.getElementById('category');
        const customCategoryInput = document.getElementById('customCategory');

        if (categorySelect.value === 'Custom' && customCategoryInput.value.trim() === '') {
            e.preventDefault();
            alert('Please enter a custom category name');
            customCategoryInput.focus();
            return;
        }

        // If custom category is selected, update the category value
        if (categorySelect.value === 'Custom') {
            // Create a hidden input with the custom category value
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'category';
            hiddenInput.value = customCategoryInput.value.trim();
            this.appendChild(hiddenInput);

            // Disable the original select to avoid conflict
            categorySelect.disabled = true;
        }
    });

    function resetForm() {
        document.getElementById('budgetForm').reset();
        document.getElementById('customCategoryGroup').style.display = 'none';
    }

    // Pre-fill form from URL parameters (optional)
    const urlParams = new URLSearchParams(window.location.search);
    const categoryParam = urlParams.get('category');
    const amountParam = urlParams.get('amount');

    if (categoryParam) {
        document.getElementById('category').value = categoryParam;
    }
    if (amountParam) {
        document.getElementById('amount').value = amountParam;
    }
</script>
</body>
</html>


