<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BudgetWise | Dashboard</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
<div class="dashboard-container">
    <aside class="sidebar">
        <div class="sidebar-header">
            <div class="logo"><i class="fas fa-chart-line"></i><h2>Budget<span>Wise</span></h2></div>
        </div>
        <div class="user-profile">
            <div class="avatar"><i class="fas fa-user-circle"></i></div>
            <div class="user-info">
                <h4 th:text="${userName}">John Doe</h4>
                <p th:text="${userEmail}">john@example.com</p>
            </div>
        </div>
        <nav class="sidebar-nav">
            <ul>
                <li class="active"><a href="/dashboard"><i class="fas fa-tachometer-alt"></i><span>Dashboard</span></a></li>
                <li><a href="/expenses"><i class="fas fa-wallet"></i><span>Expenses</span></a></li>
               <li><a href="/budgets"><i class="fas fa-chart-pie"></i><span>Budget</span><span class="badge">AI</span></a></li>
                <li><a href="/budgets/budget-and-goals"><i class="fas fa-bullseye"></i><span>Saving Goals</span></a></li>
                <li><a href="#"><i class="fas fa-robot"></i><span>AI Advisor</span></a></li>
                <li><a href="#"><i class="fas fa-bell"></i><span>Alerts</span><span class="badge">3</span></a></li>
                <li><a href="#"><i class="fas fa-chart-bar"></i><span>Reports</span></a></li>
                <li><a href="#"><i class="fas fa-cog"></i><span>Settings</span></a></li>


            </ul>
        </nav>
        <div class="sidebar-footer">
            <a href="/logout" class="logout-btn"><i class="fas fa-sign-out-alt"></i><span>Logout</span></a>
        </div>
    </aside>
    <main class="main-content">
        <header class="main-header">
            <div class="header-left">
                <h1>Welcome back, <span th:text="${firstName}">John</span>!</h1>
                <p id="currentDate">Loading date...</p>
            </div>
            <div class="header-right">
                <div class="search-box"><i class="fas fa-search"></i><input type="text" placeholder="Search..."></div>
                <div class="header-actions">
                    <button class="btn-icon" onclick="showAddExpenseModal()"><i class="fas fa-plus"></i> Add Expense</button>
                    <button class="btn-icon"><i class="fas fa-robot"></i> AI Advice</button>
                    <div class="notification"><i class="fas fa-bell"></i><span class="notification-count">3</span></div>
                </div>
            </div>
        </header>
        <section class="stats-cards">
            <div class="stat-card">
                <div class="stat-icon income"><i class="fas fa-money-bill-wave"></i></div>
                <div class="stat-info"><h3>$<span th:text="${monthlyIncome}">4,250.00</span></h3><p>Monthly Income</p></div>
                <div class="stat-trend up"><i class="fas fa-arrow-up"></i><span>5% from last month</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon expense"><i class="fas fa-shopping-cart"></i></div>
                <div class="stat-info"><h3>$<span th:text="${monthlyExpenses}">2,840.00</span></h3><p>Monthly Expenses</p></div>
                <div class="stat-trend down"><i class="fas fa-arrow-down"></i><span>12% from last month</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon savings"><i class="fas fa-piggy-bank"></i></div>
                <div class="stat-info"><h3>$<span th:text="${monthlySavings}">1,410.00</span></h3><p>Monthly Savings</p></div>
                <div class="stat-trend up"><i class="fas fa-arrow-up"></i><span>18% from last month</span></div>
            </div>
            <div class="stat-card">
                <div class="stat-icon budget"><i class="fas fa-chart-line"></i></div>
                <div class="stat-info"><h3><span th:text="${budgetUtilization}">84</span>%</h3><p>Budget Utilization</p></div>
                <div class="progress-bar"><div class="progress" th:style="'width: ' + ${budgetUtilization} + '%'"></div></div>
            </div>
        </section>
        <div class="content-row">
            <div class="content-card chart-container">
                <div class="card-header"><h3>Expense Breakdown</h3><select class="chart-period"><option>This Month</option></select></div>
                <canvas id="expenseChart"></canvas>
            </div>
            <div class="content-card ai-recommendations">
                <div class="card-header"><h3><i class="fas fa-robot"></i> AI Recommendations</h3><button class="btn-refresh"><i class="fas fa-sync-alt"></i></button></div>
                <div class="recommendation-list">
                    <div class="recommendation">
                        <div class="rec-icon high"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="rec-content"><h4>High Restaurant Spending</h4><p>You've spent $520 on dining this month</p>
                            <div class="rec-actions"><button class="btn-small">Adjust Budget</button><button class="btn-small outline">Dismiss</button></div>
                        </div>
                    </div>
                    <div class="recommendation">
                        <div class="rec-icon medium"><i class="fas fa-lightbulb"></i></div>
                        <div class="rec-content"><h4>Potential Savings</h4><p>Switch internet provider to save $25/month</p>
                            <div class="rec-actions"><button class="btn-small">View Options</button></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="content-card">
            <div class="card-header"><h3>Recent Transactions</h3><button class="btn-primary" onclick="showAddExpenseModal()"><i class="fas fa-plus"></i> Add Transaction</button></div>
            <div class="table-container">
                <table class="transactions-table">
                    <thead><tr><th>Date</th><th>Description</th><th>Category</th><th>Amount</th><th>Type</th><th>Actions</th></tr></thead>
                    <tbody>
                    <tr id="noTransactions" style="display: none;">
                        <td colspan="6" style="text-align: center; padding: 2rem; color: #666;">
                            <i class="fas fa-receipt" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>No transactions yet. Add your first expense!</p>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<!-- Add Expense Modal -->
<div class="modal" id="addExpenseModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add New Expense</h3>
            <button class="modal-close" onclick="closeModal()">&times;</button>
        </div>

        <div class="modal-body">
            <!-- FORM WITH CSRF TOKEN -->
            <form id="addExpenseForm" action="/expenses/quick-add" method="POST">
                <!-- âœ… CSRF TOKEN ADDED HERE -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

                <div class="form-group">
                    <label for="expenseDescription">Description</label>
                    <input type="text"
                           id="expenseDescription"
                           name="description"
                           placeholder="What was this expense for?"
                           required>
                </div>

                <div class="form-group">
                    <label for="expenseAmount">Amount</label>
                    <input type="number"
                           id="expenseAmount"
                           name="amount"
                           step="0.01"
                           min="0.01"
                           placeholder="0.00"
                           required>
                </div>

                <div class="form-group">
                    <label for="expenseCategory">Category</label>
                    <select id="expenseCategory" name="category" required>
                        <option value="">Select Category</option>
                        <option value="Food">Food</option>
                        <option value="Shopping">Shopping</option>
                        <option value="Transport">Transport</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Bills">Bills</option>
                        <option value="Other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="expenseDate">Date</label>
                    <input type="date" id="expenseDate" name="date" required>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-primary">Add Expense</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Scripts -->
<script src="/js/dashboard.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    // Set current date
    document.getElementById('currentDate').textContent = new Date().toLocaleDateString('en-US', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
    });

    // Set today's date in expense form
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('expenseDate').value = today;
    document.getElementById('expenseDate').max = today;

    // Initialize expense chart with real data
    document.addEventListener('DOMContentLoaded', function() {
        initExpenseChart();
        loadRecentTransactions();
    });

    function initExpenseChart() {
        const ctx = document.getElementById('expenseChart');
        if (!ctx) return;

        // Get category totals from backend (passed by Thymeleaf)
        const categoryTotals = /*[[${categoryTotals}]]*/ {};

        // If no data yet, show empty state
        if (!categoryTotals || Object.keys(categoryTotals).length === 0) {
            ctx.parentElement.innerHTML = `
                <div style="text-align: center; padding: 3rem; color: #666;">
                    <i class="fas fa-chart-pie" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <p>No expense data yet. Add your first expense to see charts!</p>
                </div>
            `;
            return;
        }

        // Prepare data for chart
        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals).map(val => val.doubleValue());

        // Color palette for categories
        const backgroundColors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0',
            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
        ];

        const expenseChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: backgroundColors.slice(0, labels.length),
                    borderWidth: 1,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'right',
                        labels: {
                            padding: 15,
                            usePointStyle: true,
                            pointStyle: 'circle',
                            font: {
                                family: "'Inter', sans-serif",
                                size: 12
                            }
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        titleFont: { family: "'Inter', sans-serif", size: 13 },
                        bodyFont: { family: "'Inter', sans-serif", size: 13 },
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return `${label}: $${value.toFixed(2)}`;
                            }
                        }
                    }
                }
            }
        });
    }

    function loadRecentTransactions() {
        // For now, show message if no transactions
        const noTransactionsRow = document.getElementById('noTransactions');
        noTransactionsRow.style.display = 'table-row';

        // Later: Fetch from API endpoint
        // fetch('/api/expenses/recent')
        //     .then(response => response.json())
        //     .then(expenses => {
        //         updateTransactionsTable(expenses);
        //     });
    }

    function updateTransactionsTable(expenses) {
        const tbody = document.querySelector('.transactions-table tbody');
        const noTransactionsRow = document.getElementById('noTransactions');

        if (!expenses || expenses.length === 0) {
            noTransactionsRow.style.display = 'table-row';
            return;
        }

        noTransactionsRow.style.display = 'none';

        // Clear existing rows (except the no transactions row)
        Array.from(tbody.children).forEach(row => {
            if (row.id !== 'noTransactions') {
                row.remove();
            }
        });

        // Add new rows
        expenses.forEach(expense => {
            const row = document.createElement('tr');

            const date = new Date(expense.date).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });

            const typeClass = expense.isIncome ? 'income-amount' : 'expense-amount';
            const typeText = expense.isIncome ? 'Income' : 'Expense';
            const amountSign = expense.isIncome ? '+' : '-';

            row.innerHTML = `
                <td>${date}</td>
                <td>${expense.description}</td>
                <td><span class="category-tag">${expense.category}</span></td>
                <td class="${typeClass}">${amountSign}$${expense.amount.toFixed(2)}</td>
                <td><span class="badge ${expense.isIncome ? 'income' : 'expense'}">${typeText}</span></td>
                <td>
                    <button class="table-action" title="Edit"><i class="fas fa-edit"></i></button>
                    <button class="table-action" title="Delete" onclick="deleteExpense(${expense.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            `;

            tbody.appendChild(row);
        });
    }

    function deleteExpense(id) {
        if (confirm('Are you sure you want to delete this expense?')) {
            // Implement: fetch(`/expenses/delete/${id}`, { method: 'GET' })
            // .then(() => {
            //     loadRecentTransactions(); // Refresh the table
            // });
            console.log('Would delete expense with id:', id);
        }
    }

    // Show success/error messages if present
    document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const success = urlParams.get('success');
        const error = urlParams.get('error');

        if (success) {
            showAlert(success, 'success');
        }
        if (error) {
            showAlert(error, 'error');
        }
    });

    function showAlert(message, type) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type}`;
        alertDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        `;
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i>
            <span>${message}</span>
        `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            alertDiv.remove();
        }, 5000);
    }
    /*]]>*/
</script>
</body>
</html>