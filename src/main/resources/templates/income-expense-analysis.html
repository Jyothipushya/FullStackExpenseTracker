<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Income vs Expense Analysis | BudgetWise AI</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
        }
        h1 {
            color: #2c3e50;
            font-size: 28px;
            font-weight: 600;
        }
        .back-btn {
            background: #4a6ee0;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            transition: background 0.3s;
        }
        .back-btn:hover {
            background: #3a5ed0;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            padding: 25px;
            border-radius: 10px;
            color: white;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .income-card {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }
        .expense-card {
            background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
        }
        .savings-card {
            background: linear-gradient(135deg, #17a2b8 0%, #20c997 100%);
        }
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin: 10px 0;
        }
        .stat-label {
            opacity: 0.9;
            font-size: 16px;
        }
        .time-filter {
            display: flex;
            justify-content: flex-end;
            margin: 20px 0;
        }
        .filter-select {
            padding: 8px 15px;
            border-radius: 5px;
            border: 1px solid #ddd;
            background: white;
            font-size: 14px;
        }
        .chart-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin: 30px 0;
        }
        .chart-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
        }
        .chart-title {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 18px;
        }
        .chart-wrapper {
            position: relative;
            height: 300px;
            width: 100%;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        th {
            background: #4a6ee0;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
        }
        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }
        tr:hover {
            background: #f8f9fa;
        }
        .positive {
            color: #28a745;
            font-weight: 600;
        }
        .negative {
            color: #dc3545;
            font-weight: 600;
        }
        .debug-info {
            background: #f0f0f0;
            padding: 15px;
            border-radius: 5px;
            margin: 20px 0;
            border-left: 4px solid #ffc107;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <h1><i class="fas fa-balance-scale"></i> Income vs Expense Analysis</h1>
        <a href="/trends/dashboard" class="back-btn">
            ← Back to Trends Dashboard
        </a>
    </div>

    <!-- Debug Info -->
    <div class="debug-info">
        <h4 style="margin: 0 0 10px 0; color: #856404;">Debug Information:</h4>
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
            <div><strong>Selected Months:</strong> <span th:text="${incomeExpenseData.selectedMonths}" style="color: #007bff;">6</span></div>
            <div><strong>Total Income:</strong> <span th:text="${incomeExpenseData.totalIncome}" style="color: #28a745;">0</span></div>
            <div><strong>Total Expenses:</strong> <span th:text="${incomeExpenseData.totalExpenses}" style="color: #dc3545;">0</span></div>
        </div>
    </div>

    <!-- Time Filter -->
    <div class="time-filter">
        <select class="filter-select" id="monthsFilter">
            <option value="3" th:selected="${incomeExpenseData.selectedMonths == 3}">Last 3 Months</option>
            <option value="6" th:selected="${incomeExpenseData.selectedMonths == 6}">Last 6 Months</option>
            <option value="12" th:selected="${incomeExpenseData.selectedMonths == 12}">Last 12 Months</option>
        </select>
    </div>

    <!-- Stats Cards -->
    <div class="stats-grid">
        <div class="stat-card income-card">
            <div class="stat-label">Total Income</div>
            <div class="stat-value" id="totalIncome">₹0</div>
            <div class="stat-label">Last <span th:text="${incomeExpenseData.selectedMonths}">6</span> Months</div>
        </div>
        <div class="stat-card expense-card">
            <div class="stat-label">Total Expenses</div>
            <div class="stat-value" id="totalExpenses">₹0</div>
            <div class="stat-label">Last <span th:text="${incomeExpenseData.selectedMonths}">6</span> Months</div>
        </div>
        <div class="stat-card savings-card">
            <div class="stat-label">Net Savings</div>
            <div class="stat-value" id="netSavings">₹0</div>
            <div class="stat-label">Last <span th:text="${incomeExpenseData.selectedMonths}">6</span> Months</div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="chart-row">
        <div class="chart-section">
            <h3 class="chart-title">Monthly Comparison</h3>
            <div class="chart-wrapper">
                <canvas id="comparisonChart"></canvas>
            </div>
        </div>
        <div class="chart-section">
            <h3 class="chart-title">Income vs Expense Ratio</h3>
            <div class="chart-wrapper">
                <canvas id="ratioChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Monthly Breakdown Table -->
    <div class="chart-section">
        <h3 class="chart-title">Monthly Breakdown</h3>
        <table id="monthlyTable">
            <thead>
            <tr>
                <th>Month</th>
                <th>Income</th>
                <th>Expenses</th>
                <th>Savings</th>
                <th>Savings %</th>
                <th>Status</th>
            </tr>
            </thead>
            <tbody id="tableBody">
            <!-- Will be populated by JavaScript -->
            </tbody>
        </table>
    </div>
</div>

<!-- Thymeleaf Data Injection -->
<script th:inline="javascript">
    /*<![CDATA[*/
    // Get JSON from controller
    var incomeExpenseJson = /*[[${incomeExpenseJson}]]*/ '{}';

    // Parse to get real data
    var incomeExpenseData = {};
    var hasRealData = false;

    try {
        if (incomeExpenseJson && incomeExpenseJson !== '{}') {
            incomeExpenseData = JSON.parse(incomeExpenseJson);
            hasRealData = true;
            console.log("Income Expense Data (JSON):", incomeExpenseData);
        } else {
            console.warn("No JSON data received from controller");
            // Fallback to empty data structure
            incomeExpenseData = {
                totalIncome: 0,
                totalExpenses: 0,
                netSavings: 0,
                labels: [],
                income: [],
                expenses: [],
                savings: [],
                monthlyData: [],
                selectedMonths: /*[[${incomeExpenseData.selectedMonths}]]*/ 6
            };
        }
    } catch (e) {
        console.error("Error parsing income expense data:", e);
        incomeExpenseData = {
            totalIncome: 0,
            totalExpenses: 0,
            netSavings: 0,
            labels: [],
            income: [],
            expenses: [],
            savings: [],
            monthlyData: [],
            selectedMonths: /*[[${incomeExpenseData.selectedMonths}]]*/ 6
        };
    }
    /*]]>*/
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        try {
            console.log("Initializing Income vs Expense Analysis with REAL data...");
            console.log("Data received:", incomeExpenseData);

            // Set up filter
            const monthsFilter = document.getElementById('monthsFilter');
            if (monthsFilter) {
                monthsFilter.value = incomeExpenseData.selectedMonths || 6;
                monthsFilter.addEventListener('change', function() {
                    window.location.href = '/trends/income-expense-analysis?months=' + this.value;
                });
            }

            // 1. Update Stats Cards
            document.getElementById('totalIncome').textContent =
                '₹' + formatCurrency(incomeExpenseData.totalIncome || 0);
            document.getElementById('totalExpenses').textContent =
                '₹' + formatCurrency(incomeExpenseData.totalExpenses || 0);
            document.getElementById('netSavings').textContent =
                '₹' + formatCurrency(incomeExpenseData.netSavings || 0);

            // 2. Create charts only if we have data
            if (incomeExpenseData.labels && incomeExpenseData.labels.length > 0) {
                // Monthly Comparison Chart (Bar)
                const comparisonCtx = document.getElementById('comparisonChart').getContext('2d');
                new Chart(comparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: incomeExpenseData.labels,
                        datasets: [
                            {
                                label: 'Income',
                                data: incomeExpenseData.income,
                                backgroundColor: '#28a745',
                                borderColor: '#28a745',
                                borderWidth: 1
                            },
                            {
                                label: 'Expenses',
                                data: incomeExpenseData.expenses,
                                backgroundColor: '#dc3545',
                                borderColor: '#dc3545',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return '₹' + formatCurrency(value);
                                    }
                                }
                            }
                        }
                    }
                });

                // Ratio Chart (Doughnut)
                const ratioCtx = document.getElementById('ratioChart').getContext('2d');
                new Chart(ratioCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Income', 'Expenses'],
                        datasets: [{
                            data: [incomeExpenseData.totalIncome || 0, incomeExpenseData.totalExpenses || 0],
                            backgroundColor: ['#28a745', '#dc3545'],
                            borderWidth: 2,
                            borderColor: '#fff'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        cutout: '60%',
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const value = context.raw || 0;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? Math.round((value / total) * 100) : 0;
                                        return `${context.label}: ₹${formatCurrency(value)} (${percentage}%)`;
                                    }
                                }
                            }
                        }
                    }
                });
            } else {
                // Show "No Data" messages in charts
                document.getElementById('comparisonChart').parentElement.innerHTML =
                    '<div style="text-align: center; padding: 40px; color: #666;">No comparison data available</div>';
                document.getElementById('ratioChart').parentElement.innerHTML =
                    '<div style="text-align: center; padding: 40px; color: #666;">No ratio data available</div>';
            }

            // 4. Populate Monthly Table
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '';

            if (incomeExpenseData.monthlyData && incomeExpenseData.monthlyData.length > 0) {
                incomeExpenseData.monthlyData.forEach(item => {
                    const row = document.createElement('tr');
                    const statusClass = item.savings > 0 ? 'positive' : 'negative';
                    const statusText = item.savings > 0 ? 'Good' : 'Attention';

                    row.innerHTML = `
                        <td><strong>${item.month}</strong></td>
                        <td>₹${formatCurrency(item.income || 0)}</td>
                        <td>₹${formatCurrency(item.expenses || 0)}</td>
                        <td class="${statusClass}">₹${formatCurrency(item.savings || 0)}</td>
                        <td>${item.percentage || 0}%</td>
                        <td><span class="${statusClass}">${statusText}</span></td>
                    `;
                    tableBody.appendChild(row);
                });
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: #666;">
                            <i class="fas fa-chart-line"></i><br>
                            No data available for the selected period.<br>
                            <small>Try adding some income and expense transactions.</small>
                        </td>
                    </tr>
                `;
            }

            console.log("Income vs Expense Analysis initialized successfully!");

        } catch (error) {
            console.error("Error initializing page:", error);

            // Show error message
            const container = document.querySelector('.container');
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = `
                background: #fee;
                border: 1px solid #f5c6cb;
                color: #721c24;
                padding: 15px;
                border-radius: 5px;
                margin: 20px 0;
            `;
            errorDiv.innerHTML = `
                <h4><i class="fas fa-exclamation-triangle"></i> Error Loading Page</h4>
                <p>${error.message}</p>
                <p>Please check console for details.</p>
                <button onclick="location.reload()" class="back-btn" style="margin-top: 10px;">
                    <i class="fas fa-redo"></i> Reload Page
                </button>
            `;
            container.insertBefore(errorDiv, container.firstChild);
        }
    });

    // Helper function to format currency
    function formatCurrency(value) {
        const num = parseFloat(value);
        if (isNaN(num)) return '0';

        if (num >= 100000) {
            return (num / 100000).toFixed(1) + 'L';
        } else if (num >= 1000) {
            return (num / 1000).toFixed(1) + 'K';
        }

        return Math.round(num).toLocaleString('en-IN');
    }
</script>
</body>
</html>